<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Peso</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --p: #007AFF; --bg: #F2F2F7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #000; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; background: var(--p); color: white; border: none; padding: 14px; border-radius: 10px; font-size: 16px; font-weight: bold; }
        #listaPesi { font-size: 14px; margin-top: 10px; }
        .dato-riga { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
        .chart-container { height: 200px; position: relative; }
        .error-msg { color: red; font-size: 12px; text-align: center; display: none; }
        .reset-btn { background: #FF3B30; margin-top: 20px; }
    </style>
</head>
<body>

    <div style="max-width: 400px; margin: auto;">
        <h2 style="text-align:center">Tracker Peso</h2>

        <div class="card">
            <label>Data</label>
            <input type="date" id="dataInput">

            <label>Peso (kg)</label>
            <input type="text" id="pesoInput" placeholder="Esempio: 70.5">

            <button id="btnAggiungi">AGGIUNGI PESO</button>
        </div>

        <div class="card">
            <div id="msgErrore" class="error-msg">Connessione internet necessaria per il grafico</div>
            <div class="chart-container">
                <canvas id="grafico"></canvas>
            </div>
        </div>

        <div class="card">
            <strong>Cronologia:</strong>
            <div id="listaPesi"></div>
        </div>

        <button class="reset-btn" id="btnReset">CANCELLA TUTTO</button>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {

        let chartInstance = null;
        let datiCache = [];

        const dataInput = document.getElementById("dataInput");
        const pesoInput = document.getElementById("pesoInput");
        const btnAggiungi = document.getElementById("btnAggiungi");
        const btnReset = document.getElementById("btnReset");
        const listaDiv = document.getElementById("listaPesi");
        const msgErrore = document.getElementById("msgErrore");
        const canvas = document.getElementById("grafico");

        // Imposta data oggi
        dataInput.value = new Date().toISOString().split("T")[0];

        function caricaDati() {
            try {
                const raw = localStorage.getItem("storico_pesi");
                datiCache = raw ? JSON.parse(raw) : [];
            } catch {
                datiCache = [];
            }
        }

        function salvaDati() {
            try {
                localStorage.setItem("storico_pesi", JSON.stringify(datiCache));
            } catch {}
        }

        function aggiornaLista() {
            listaDiv.innerHTML = "";
            datiCache.slice().reverse().forEach(item => {
                listaDiv.innerHTML += `<div class="dato-riga"><span>${item.d}</span> <b>${item.p} kg</b></div>`;
            });
        }

        function disegnaGrafico() {
            if (typeof Chart === "undefined") {
                msgErrore.style.display = "block";
                return;
            }

            msgErrore.style.display = "none";

            const ctx = canvas.getContext("2d");
            const labels = datiCache.map(x => x.d);
            const values = datiCache.map(x => x.p);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Peso",
                        data: values,
                        borderColor: "#007AFF",
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function aggiornaUI() {
            aggiornaLista();
            disegnaGrafico();
        }

        function aggiungiDato() {
            const dataVal = dataInput.value;
            let pesoVal = pesoInput.value.trim().replace(",", ".");

            if (!dataVal || !pesoVal || isNaN(pesoVal)) {
                alert("Inserisci data e peso validi");
                return;
            }

            datiCache.push({ d: dataVal, p: parseFloat(pesoVal) });
            datiCache.sort((a, b) => new Date(a.d) - new Date(b.d));

            salvaDati();
            pesoInput.value = "";
            aggiornaUI();
        }

        function svuotaTutto() {
            if (!confirm("Vuoi cancellare tutto")) return;
            datiCache = [];
            localStorage.removeItem("storico_pesi");
            aggiornaUI();
        }

        btnAggiungi.addEventListener("click", aggiungiDato);
        btnReset.addEventListener("click", svuotaTutto);

        caricaDati();
        aggiornaUI();
    });
    </script>

</body>
</html>
